worker_processes 4;
pid /tmp/nginx.pid;

error_log /dev/stdout warn;

events {
    worker_connections  4096;
}

http {
    # PageSpeed Admin
    pagespeed on;
    pagespeed RewriteLevel PassThrough;
    pagespeed Statistics on;
    pagespeed StatisticsLogging on;
    pagespeed FileCachePath /var/cache/ngx_pagespeed_cache;
    pagespeed ModPagespeedRewriteLevel PassThrough;
    pagespeed Domain *.*;
    pagespeed LogDir /var/log/pagespeed;
    pagespeed AdminPath /pagespeed_admin;
    pagespeed StatisticsPath /ngx_pagespeed_statistics;
    pagespeed GlobalStatisticsPath /ngx_pagespeed_global_statistics;
    pagespeed MessagesPath /ngx_pagespeed_message;
    pagespeed ConsolePath /pagespeed_console;
    pagespeed GlobalAdminPath /pagespeed_global_admin;
    pagespeed MessageBufferSize 1024;

    # PageSpeed Cache Purge
    pagespeed EnableCachePurge on;
    pagespeed PurgeMethod PURGE;

    #PageSpeed filters
    pagespeed EnableFilters add_head;
    pagespeed EnableFilters combine_css;
    pagespeed EnableFilters combine_javascript;
    pagespeed EnableFilters convert_meta_tags;
    pagespeed EnableFilters extend_cache;
    pagespeed EnableFilters fallback_rewrite_css_urls;
    pagespeed EnableFilters flatten_css_imports;
    pagespeed EnableFilters inline_css;
    pagespeed EnableFilters inline_import_to_link;
    pagespeed EnableFilters inline_javascript;
    pagespeed EnableFilters rewrite_css;
    pagespeed EnableFilters rewrite_images;
    pagespeed EnableFilters rewrite_javascript;
    pagespeed EnableFilters rewrite_style_attributes_with_url;
    pagespeed FetchHttps enable;
    pagespeed EnableFilters remove_comments; 
    pagespeed EnableFilters convert_jpeg_to_progressive,convert_png_to_jpeg,convert_jpeg_to_webp,convert_to_webp_lossless;
    pagespeed EnableFilters recompress_images;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    directio 512;
    server_tokens off;
    include mime.types;
    default_type application/octet-stream;
    limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;
    proxy_connect_timeout       15;
    proxy_send_timeout          15;
    proxy_read_timeout          15;
    send_timeout                15;
    keepalive_timeout           15;

    log_format le_json '{ "time": "$time_iso8601", '
        '"remote_addr": "$remote_addr", '
        '"remote_user": "$remote_user", '
        '"body_bytes_sent": "$body_bytes_sent", '
        '"request_time": "$request_time", '
        '"status": "$status", '
        '"request": "$request", '
        '"request_method": "$request_method", '
        '"http_referrer": "$http_referer", '
        '"http_user_agent": "$http_user_agent" }';

    access_log  /dev/stdout le_json;

    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name o3dv.herokuapp.com o3dv-stg.herokuapp.com;
        if ($scheme = http) {
           return 301 https://$server_name$request_uri;
        };
    }

    server {
        server_name o3dv.herokuapp.com o3dv-stg.herokuapp.com;
        listen 443 ssl http2;
        listen [::]443 ssl https2;
        #
        # Pagespeed Module access 
        #  // TODO Hardening coming later in development 
        #
        location ~ ^/ngx_pagespeed_statistics { 
            allow 127.0.0.1;
            deny all; 
        }
        location /ngx_pagespeed_global_statistics {
            allow 127.0.0.1;
            deny all; 
         }
        location /ngx_pagespeed_message {             
            allow 127.0.0.1;
            deny all; 
        }
        location /pagespeed_console {
            allow all; 
        }
        location ~ ^/pagespeed_admin {
            allow 127.0.0.1;
            deny all; 
        }
        location ~ ^/pagespeed_global_admin { 
            allow 127.0.0.1;
            deny all; 
        }
        # Ensure requests for pagespeed optimized resources go to the pagespeed handler
        # and no extraneous headers get set.
        location ~ "\.pagespeed\.([a-z]\.)?[a-z]{2}\.[^.]{10}\.[^.]+" {
            add_header "" "";
        }
        location ~ ^/pagespeed_static$ {             
            allow all;  
        }
        location ~ ^/ngx_pagespeed_beacon$ {
            allow all; 
        }

        #
        # Location/Domain/Listen settings
        #

        location / {
        #
        # CORS 
        #
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            #
            # Custom headers and headers various browsers *should* be OK with but aren't
            #
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
            #
            # Tell client that this pre-flight info is valid for 20 days
            #
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
            }
            if ($request_method = 'POST') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }
            if ($request_method = 'GET') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }
            root /build;
        }

    }
}
